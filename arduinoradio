#include <Wire.h>               // I2C haberleşmesi için gerekli kütüphane
#include <LiquidCrystal.h>      // LCD ekran kullanımı için gerekli kütüphane

unsigned char frekansH = 0;     // Frekans yüksek byte'ı
unsigned char frekansL = 0;     // Frekans düşük byte'ı

unsigned int frekansB;          // Frekansın hesaplanmış hali (ara değer)
double frekans = 0;             // Frekansın double olarak değeri

static char frekans_ekran[15];  // LCD ekranda gösterilecek frekans değeri

LiquidCrystal lcd(12, 11, 5, 4, 3, 2);  // LCD ekran bağlantı pinleri

void setup() {
  Wire.begin();               // I2C haberleşmesini başlat
  lcd.begin(16, 2);           // LCD ekranı başlat (16 sütun, 2 satır)
  frekans = 93.0;             // Başlangıç frekansını 93.0 MHz olarak ayarla
  frekansAyarla();            // Frekansı ayarla
  lcd.setCursor(3, 0);        // LCD ekranın 1. satırının 4. sütununa imleci yerleştir
  lcd.print("FM Radyo");      // LCD ekrana "FM Radyo" yazdır
}

void loop() {
  int reading = analogRead(A0);  // A0 pininden analog okuma yap
  frekans = ((double)reading * (108.0 - 87.5)) / 1024.0 + 87.5;  // Okunan değeri frekansa dönüştür
  frekans = ((int)(frekans * 10)) / 10.0;                        // Frekansı bir ondalık basamağa yuvarla
  frekansAyarla();            // Frekansı ayarla
  dtostrf(frekans, 6, 2, frekans_ekran);  // Frekansı ekranda gösterilecek stringe çevir
  lcd.setCursor(4, 1);        // LCD ekranın 2. satırının 5. sütununa imleci yerleştir
  lcd.print(frekans_ekran);   // LCD ekrana frekansı yazdır
}

void frekansAyarla() {
  frekansB = 4 * (frekans * 1000000 + 225000) / 32768;  // Frekans değerini hesapla
  frekansH = frekansB >> 8;  // Yüksek byte'ı hesapla
  frekansL = frekansB & 0XFF;  // Düşük byte'ı hesapla
  delay(100);                 // Kısa bir gecikme
  Wire.beginTransmission(0x60);  // I2C haberleşmesini başlat (0x60 adresi ile)
  Wire.write(frekansH);         // Yüksek byte'ı gönder
  Wire.write(frekansL);         // Düşük byte'ı gönder
  Wire.write(0xB0);             // Kontrol byte'ı gönder
  Wire.write(0x10);             // Kontrol byte'ı gönder
  Wire.write((byte)0x00);       // Ekstra byte (0)
  Wire.endTransmission();       // I2C haberleşmesini bitir
  delay(100);                   // Kısa bir gecikme
}
